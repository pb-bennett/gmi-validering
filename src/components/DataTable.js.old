'use client';

import { useMemo, useState } from 'react';
import useStore from '@/lib/store';
import fieldsData from '@/data/fields.json';

export default function DataTable() {
  const data = useStore((state) => state.data);
  const setHighlightedFeature = useStore(
    (state) => state.setHighlightedFeature
  );
  const toggleDataTable = useStore((state) => state.toggleDataTable);
  const setMapCenter = useStore((state) => state.setMapCenter);

  const [activeTab, setActiveTab] = useState('punkter');
  const [columnOrder, setColumnOrder] = useState([]);
  const [sortConfig, setSortConfig] = useState({
    field: null,
    direction: null,
  });
  const [draggedColumn, setDraggedColumn] = useState(null);

  // Get the appropriate dataset
  const items = useMemo(() => {
    if (!data) return [];
    return activeTab === 'punkter' ? data.points : data.lines;
  }, [data, activeTab]);

  // Extract field names with data (S_FCODE always first)
  const allFields = useMemo(() => {
    if (items.length === 0) return [];

    const fieldSet = new Set();
    const fieldHasData = {};

    items.forEach((item) => {
      if (item.attributes) {
        Object.keys(item.attributes).forEach((key) => {
          fieldSet.add(key);
          const value = item.attributes[key];
          if (value !== null && value !== undefined && value !== '') {
            fieldHasData[key] = true;
          }
        });
      }
    });

    // Only include fields that have at least one non-empty value
    const fields = Array.from(fieldSet).filter(
      (field) => fieldHasData[field]
    );

    // S_FCODE always first
    const sfcodeIndex = fields.indexOf('S_FCODE');
    if (sfcodeIndex > -1) {
      fields.splice(sfcodeIndex, 1);
      fields.unshift('S_FCODE');
    }

    return fields;
  }, [items]);

  // Use the stateful order if the user has reordered columns; otherwise fall back to allFields.
  const effectiveColumnOrder =
    columnOrder.length > 0 ? columnOrder : allFields;

  // Get field label from fields.json
  const getFieldLabel = (fieldName) => {
    const fieldDef = fieldsData.find((f) => f.fieldKey === fieldName);
    return fieldDef?.label || fieldName;
  };

  // Sort data
  const sortedItems = useMemo(() => {
    if (!sortConfig.field || !sortConfig.direction) return items;

    return [...items].sort((a, b) => {
      const aVal = a.attributes?.[sortConfig.field];
      const bVal = b.attributes?.[sortConfig.field];

      // Handle nulls
      if (aVal === null || aVal === undefined) return 1;
      if (bVal === null || bVal === undefined) return -1;

      // Compare
      let comparison = 0;
      if (typeof aVal === 'string') {
        comparison = aVal.localeCompare(String(bVal));
      } else {
        comparison = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
      }

      return sortConfig.direction === 'asc'
        ? comparison
        : -comparison;
    });
  }, [items, sortConfig]);

  // Handle column sort
  const handleSort = (field) => {
    setSortConfig((current) => {
      if (current.field !== field) {
        return { field, direction: 'asc' };
      }
      if (current.direction === 'asc') {
        return { field, direction: 'desc' };
      }
      return { field: null, direction: null };
    });
  };

  // Handle row click (highlight on map)
  const handleRowClick = (item, index) => {
    const featureId = `${activeTab}-${index}`;
    setHighlightedFeature(featureId);
  };

  // Handle zoom to feature
  const handleZoomTo = (item, index, e) => {
    e.stopPropagation();
    const featureId = `${activeTab}-${index}`;
    setHighlightedFeature(featureId);

    // Trigger map pan/zoom
    if (item.coordinates) {
      const coords =
        Array.isArray(item.coordinates) && item.coordinates.length > 0
          ? item.coordinates[0]
          : item.coordinates;

      if (
        coords &&
        coords.x !== undefined &&
        coords.y !== undefined
      ) {
        // Store coordinates for MapView to use
        window.dispatchEvent(
          new CustomEvent('zoomToFeature', {
            detail: { x: coords.x, y: coords.y, featureId },
          })
        );
      }
    }
  };

  // Drag and drop handlers
  const handleDragStart = (e, field) => {
    if (field === 'S_FCODE') return; // Can't drag S_FCODE
    setDraggedColumn(field);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e, targetField) => {
    e.preventDefault();
    if (targetField === 'S_FCODE' || !draggedColumn) return;
  };

  const handleDrop = (e, targetField) => {
    e.preventDefault();
    if (
      targetField === 'S_FCODE' ||
      !draggedColumn ||
      draggedColumn === targetField
    ) {
      setDraggedColumn(null);
      return;
    }

    const newOrder = [...effectiveColumnOrder];
    const draggedIndex = newOrder.indexOf(draggedColumn);
    const targetIndex = newOrder.indexOf(targetField);

    newOrder.splice(draggedIndex, 1);
    newOrder.splice(targetIndex, 0, draggedColumn);

    setColumnOrder(newOrder);
    setDraggedColumn(null);
  };

  if (!data) return null;

  return (
    <div className="h-full flex flex-col border-t">
      {/* Simplified header: explicit flex layout to avoid table layout issues */}
      <div
        id="datatable-header"
        ref={headerRef}
        style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '10px 16px',
          borderBottom: '1px solid #e5e7eb',
          background: 'white',
          position: 'sticky',
          top: 0,
          zIndex: 3000,
          minHeight: '48px',
          overflow: 'visible',
        }}
      >
        <div
          style={{
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            minWidth: 0,
            flex: '1 1 auto',
            maxWidth: 'calc(100% - 120px)',
            overflow: 'hidden',
          }}
        >
          <div
            style={{
              fontWeight: 600,
              fontSize: '14px',
              color: '#111827',
              whiteSpace: 'nowrap',
              overflow: 'hidden',
              textOverflow: 'ellipsis',
            }}
          >
            Datatabell
          </div>
          <div
            style={{
              display: 'flex',
              gap: '6px',
              alignItems: 'center',
              overflow: 'hidden',
            }}
          >
            <button
              onClick={() => setActiveTab('punkter')}
              style={{
                padding: '6px 12px',
                background:
                  activeTab === 'punkter' ? '#3b82f6' : 'transparent',
                color: activeTab === 'punkter' ? 'white' : '#6b7280',
                border: 'none',
                borderRadius: '6px',
                cursor: 'pointer',
                fontSize: '13px',
                fontWeight: 500,
                flexShrink: 0,
              }}
            >
              Punkter ({data.points.length})
            </button>
            <button
              onClick={() => setActiveTab('ledninger')}
              style={{
                padding: '6px 12px',
                background:
                  activeTab === 'ledninger'
                    ? '#3b82f6'
                    : 'transparent',
                color:
                  activeTab === 'ledninger' ? 'white' : '#6b7280',
                border: 'none',
                borderRadius: '6px',
                cursor: 'pointer',
                fontSize: '13px',
                fontWeight: 500,
                flexShrink: 0,
              }}
            >
              Ledninger ({data.lines.length})
            </button>
          </div>
        </div>

        {/* Inline close button placed in the header */}
        <div style={{ flexShrink: 0, marginLeft: '12px' }}>
          <button
            id="datatable-close-button-inline"
            data-debug="true"
            aria-label="Lukk tabell"
            onClick={() => {
              console.log('Inline close clicked');
              toggleDataTable();
            }}
            style={{
              display: 'inline-flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '6px 12px',
              background: '#ffffff',
              color: '#374151',
              border: '2px solid #e5e7eb',
              borderRadius: '6px',
              cursor: 'pointer',
              fontSize: '13px',
              fontWeight: 700,
              pointerEvents: 'auto',
              opacity: 1,
              visibility: 'visible',
              zIndex: 99999,
              minWidth: '48px',
            }}
          >
            Close
          </button>
        </div>
      </div>

      {/* Table */}
      <div
        className="flex-1"
        style={{
          overflowX: 'auto',
          overflowY: 'auto',
          width: '100%',
          position: 'relative',
        }}
      >
        {/* Fixed close button positioned by header bounding rect - guaranteed visible */}
        {closePos && (
          <button
            id="datatable-close-fixed-from-header"
            aria-label="Lukk tabell (from header)"
            onClick={() => {
              console.log('Fixed-from-header clicked');
              toggleDataTable();
            }}
            style={{
              position: 'fixed',
              top: `${closePos.top}px`,
              left: `${closePos.left}px`,
              width: '40px',
              height: '40px',
              borderRadius: '8px',
              background: 'white',
              color: '#374151',
              border: '1px solid #e5e7eb',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 2147483647,
            }}
          >
            √ó
          </button>
        )}
        <table
          className="text-xs border-collapse"
          style={{ minWidth: 'max-content', width: 'max-content' }}
        >
          <thead
            className="sticky top-0 z-10"
            style={{ backgroundColor: 'var(--color-page-bg)' }}
          >
            <tr>
              {/* Zoom column */}
              <th
                className="sticky left-0 z-20 px-1.5 py-1 text-center border-b border-r font-medium"
                style={{
                  backgroundColor: 'var(--color-page-bg)',
                  borderColor: 'var(--color-border)',
                  color: 'var(--color-text-secondary)',
                  minWidth: '50px',
                }}
              >
                Zoom
              </th>

              {/* Data columns */}
              {effectiveColumnOrder.map((field, idx) => {
                const isFixed = field === 'S_FCODE';
                const isSorted = sortConfig.field === field;

                return (
                  <th
                    key={field}
                    draggable={!isFixed}
                    onDragStart={(e) => handleDragStart(e, field)}
                    onDragOver={(e) => handleDragOver(e, field)}
                    onDrop={(e) => handleDrop(e, field)}
                    onClick={() => handleSort(field)}
                    className={`px-2 py-1 text-left border-b font-medium cursor-pointer hover:bg-opacity-50 ${
                      isFixed ? 'sticky z-20 border-r' : ''
                    }`}
                    style={{
                      backgroundColor: isFixed
                        ? 'var(--color-page-bg)'
                        : 'transparent',
                      borderColor: 'var(--color-border)',
                      color: 'var(--color-text)',
                      left: isFixed ? '50px' : 'auto',
                      minWidth: '100px',
                      userSelect: 'none',
                      WebkitUserSelect: 'none',
                    }}
                  >
                    <div className="flex items-center gap-1">
                      <span>{getFieldLabel(field)}</span>
                      {isSorted && (
                        <span
                          style={{ color: 'var(--color-primary)' }}
                        >
                          {sortConfig.direction === 'asc' ? '‚Üë' : '‚Üì'}
                        </span>
                      )}
                      {!isFixed && (
                        <span className="text-[10px] opacity-50">
                          ‚ãÆ‚ãÆ
                        </span>
                      )}
                    </div>
                  </th>
                );
              })}
            </tr>
          </thead>
          <tbody>
            {sortedItems.map((item, index) => {
              const featureId = `${activeTab}-${index}`;
              return (
                <tr
                  key={index}
                  onClick={() => handleRowClick(item, index)}
                  className="hover:bg-opacity-50 cursor-pointer border-b"
                  style={{
                    borderColor: 'var(--color-border)',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor =
                      'var(--color-page-bg)';
                    setHighlightedFeature(featureId);
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor =
                      'transparent';
                    setHighlightedFeature(null);
                  }}
                >
                  {/* Zoom button */}
                  <td
                    className="sticky left-0 z-10 px-1.5 py-1 text-center border-r"
                    style={{
                      backgroundColor: 'var(--color-card)',
                      borderColor: 'var(--color-border)',
                    }}
                  >
                    <button
                      onClick={(e) => handleZoomTo(item, index, e)}
                      className="px-1.5 py-0.5 text-[10px] rounded transition-colors"
                      style={{
                        color: 'var(--color-primary)',
                        backgroundColor: 'var(--color-page-bg)',
                      }}
                      onMouseEnter={(e) =>
                        (e.currentTarget.style.backgroundColor =
                          'var(--color-primary-light)')
                      }
                      onMouseLeave={(e) =>
                        (e.currentTarget.style.backgroundColor =
                          'var(--color-page-bg)')
                      }
                    >
                      üîç
                    </button>
                  </td>

                  {/* Data cells */}
                  {effectiveColumnOrder.map((field) => {
                    const value = item.attributes?.[field];
                    const displayValue =
                      value === null ||
                      value === undefined ||
                      value === ''
                        ? '-'
                        : String(value);
                    const isFixed = field === 'S_FCODE';

                    return (
                      <td
                        key={field}
                        className={`px-2 py-1 ${
                          isFixed
                            ? 'sticky z-10 border-r font-medium'
                            : ''
                        }`}
                        style={{
                          backgroundColor: isFixed
                            ? 'var(--color-card)'
                            : 'transparent',
                          borderColor: 'var(--color-border)',
                          color:
                            displayValue === '-'
                              ? 'var(--color-text-secondary)'
                              : 'var(--color-text)',
                          left: isFixed ? '50px' : 'auto',
                        }}
                      >
                        {displayValue}
                      </td>
                    );
                  })}
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* Footer with row count */}
      <div
        className="px-4 py-2 border-t text-xs"
        style={{
          borderColor: 'var(--color-border)',
          color: 'var(--color-text-secondary)',
          backgroundColor: 'var(--color-page-bg)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        }}
      >
        <div>
          Viser {sortedItems.length}{' '}
          {activeTab === 'punkter' ? 'punkter' : 'ledninger'}
        </div>
        <div>
          <button
            id="datatable-close-button-footer"
            onClick={() => {
              console.log('Footer close clicked');
              toggleDataTable();
            }}
            style={{
              padding: '6px 12px',
              background: '#f3f4f6',
              color: '#111827',
              border: '1px solid #e5e7eb',
              borderRadius: '6px',
              cursor: 'pointer',
              fontSize: '13px',
              fontWeight: 600,
            }}
          >
            Lukk
          </button>
        </div>
      </div>
    </div>
  );
}
